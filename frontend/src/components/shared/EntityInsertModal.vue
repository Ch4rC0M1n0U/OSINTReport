<template>
  <div v-if="isOpen" class="modal modal-open">
    <div class="modal-box w-11/12 max-w-3xl">
      <h3 class="text-lg font-bold mb-4">
        üë§ Ins√©rer une entit√© ou une donn√©e
      </h3>

      <!-- Onglets de s√©lection -->
      <div class="tabs tabs-boxed mb-4">
        <button
          v-if="props.reportId"
          @click="dataType = 'findings'"
          :class="['tab', dataType === 'findings' && 'tab-active']"
        >
          üìä √âl√©ments du rapport
        </button>
        <button
          @click="dataType = 'entities'"
          :class="['tab', dataType === 'entities' && 'tab-active']"
        >
          üë§ Entit√©s syst√®me
        </button>
      </div>

      <!-- Barre de recherche -->
      <div class="form-control mb-4">
        <label class="label">
          <span class="label-text">{{ dataType === 'findings' ? 'Rechercher un √©l√©ment' : 'Rechercher une entit√©' }}</span>
        </label>
        <input
          v-model="searchQuery"
          type="text"
          :placeholder="dataType === 'findings' ? 'Robert Redford, ACME, profil Facebook...' : 'Nom, pr√©nom, organisation...'"
          class="input input-bordered w-full"
          @input="handleSearch"
          ref="searchInputRef"
        />
      </div>

      <!-- Liste des entit√©s disponibles -->
      <div v-if="loading" class="flex justify-center py-8">
        <span class="loading loading-spinner loading-lg"></span>
      </div>

      <div v-else-if="error" class="alert alert-error mb-4">
        <span>{{ error }}</span>
      </div>

      <div v-else-if="displayItems.length === 0" class="text-center py-8 text-base-content/60">
        <p>Aucune donn√©e trouv√©e</p>
        <p class="text-sm mt-2">{{ searchQuery ? 'Essayez une autre recherche' : dataType === 'entities' ? 'Cr√©ez d\'abord des entit√©s pour ce rapport' : 'Aucune donn√©e de plateforme disponible' }}</p>
      </div>

      <div v-else class="space-y-2 max-h-96 overflow-y-auto">
        <!-- Affichage des entit√©s -->
        <template v-if="dataType === 'entities'">
          <button
            v-for="entity in filteredEntities"
            :key="entity.id"
            type="button"
            @click="selectEntity(entity)"
            class="w-full text-left p-3 border border-base-300 rounded-lg hover:bg-base-200 transition-colors flex items-center gap-3"
          >
            <span class="text-2xl">{{ getEntityIcon(entity.type) }}</span>
            <div class="flex-1 min-w-0">
              <div class="font-semibold truncate">{{ entity.label }}</div>
              <div class="text-sm text-base-content/60">
                {{ getEntityTypeLabel(entity.type) }}
              </div>
              <div v-if="entity.notes" class="text-xs text-base-content/50 truncate mt-1">
                {{ entity.notes }}
              </div>
            </div>
            <span class="badge badge-sm badge-primary">Ins√©rer</span>
          </button>
        </template>

        <!-- Affichage des findings -->
        <template v-else>
          <button
            v-for="(finding, index) in filteredFindings"
            :key="index"
            type="button"
            @click="selectFinding(finding)"
            class="w-full text-left p-3 border border-base-300 rounded-lg hover:bg-base-200 transition-colors flex items-center gap-3"
          >
            <span class="text-2xl">üåê</span>
            <div class="flex-1 min-w-0">
              <div class="font-semibold truncate">{{ finding.label }}</div>
              <div class="text-sm text-base-content/60 line-clamp-2">
                {{ finding.description }}
              </div>
              <div v-if="finding.confidence" class="text-xs mt-1">
                <span class="badge badge-xs" :class="getConfidenceBadgeClass(finding.confidence)">
                  {{ getConfidenceLabel(finding.confidence) }}
                </span>
              </div>
            </div>
            <span class="badge badge-sm badge-secondary">Ins√©rer</span>
          </button>
        </template>
      </div>

      <!-- Actions -->
      <div class="modal-action">
        <button type="button" class="btn btn-ghost" @click="handleClose">
          Annuler
        </button>
      </div>
    </div>
    <div class="modal-backdrop" @click="handleClose"></div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch, nextTick } from 'vue';
import { entitiesApi, type Entity, type EntityType } from '../../services/api/entities';
import type { Finding, ConfidenceLevel } from '../../services/api/reports';
import { reportsApi, type EntitiesPayload } from '../../services/api/reports';

interface Props {
  isOpen: boolean;
  reportId?: string;
  findings?: Finding[]; // Donn√©es de plateformes disponibles
}

interface Emits {
  (e: 'close'): void;
  (e: 'select', entity: Entity | Finding, htmlContent?: string): void;
}

const props = defineProps<Props>();
const emit = defineEmits<Emits>();

const searchQuery = ref('');
const entities = ref<Entity[]>([]);
const reportFindings = ref<Finding[]>([]); // √âl√©ments dynamiques du rapport (Robert Redford, ACME, etc.)
const loading = ref(false);
const error = ref<string | null>(null);
const searchInputRef = ref<HTMLInputElement | null>(null);
const dataType = ref<'entities' | 'findings'>('findings'); // Par d√©faut: √©l√©ments du rapport

// Ic√¥nes par type d'entit√©
const entityIcons: Record<EntityType, string> = {
  PERSON: 'üë§',
  ORGANIZATION: 'üè¢',
  TELEPHONE: 'üìû',
  EMAIL: 'üìß',
  ACCOUNT: 'üë§',
  ADDRESS: 'üìç',
  OTHER: 'üè∑Ô∏è',
};

// Labels par type d'entit√©
const entityTypeLabels: Record<EntityType, string> = {
  PERSON: 'Personne',
  ORGANIZATION: 'Organisation',
  TELEPHONE: 'T√©l√©phone',
  EMAIL: 'Email',
  ACCOUNT: 'Compte',
  ADDRESS: 'Adresse',
  OTHER: 'Autre',
};

// Charger les entit√©s
async function loadEntities() {
  loading.value = true;
  error.value = null;
  
  try {
    // Si on a un reportId, charger les √©l√©ments dynamiques du rapport (Finding)
    if (props.reportId) {
      await loadReportFindings();
    } else {
      // Sinon, charger toutes les entit√©s du syst√®me
      const response = await entitiesApi.list({
        limit: 100,
      });
      entities.value = response.items;
    }
  } catch (err: any) {
    error.value = err.message || 'Erreur lors du chargement des entit√©s';
    console.error('Erreur chargement entit√©s:', err);
  } finally {
    loading.value = false;
  }
}

// Charger tous les Finding (√©l√©ments dynamiques) du rapport
async function loadReportFindings() {
  if (!props.reportId) return;
  
  try {
    // 1. R√©cup√©rer tous les modules du rapport
    const modules = await reportsApi.listModules(props.reportId);
    
    // 2. Extraire tous les Finding de TOUS les modules
    const allFindings: Finding[] = [];
    
    for (const module of modules) {
      // Module "entities" (üë• Entit√©s concern√©es / Entit√©s Identifi√©es)
      if (module.type === 'entities' && module.payload) {
        const payload = module.payload as any;
        if (payload.findings && Array.isArray(payload.findings)) {
          allFindings.push(...payload.findings);
        }
      }
      
      // Module "entity_overview" (üë§ Vue d'ensemble d'une entit√©)
      if (module.type === 'entity_overview' && module.payload) {
        const payload = module.payload as any;
        if (payload.findings && Array.isArray(payload.findings)) {
          allFindings.push(...payload.findings);
        }
      }
      
      // Module "identifier_lookup" (üîé Recherche d'identifiant)
      if (module.type === 'identifier_lookup' && module.payload) {
        const payload = module.payload as any;
        if (payload.findings && Array.isArray(payload.findings)) {
          allFindings.push(...payload.findings);
        }
      }
      
      // Module "platform_analysis" (üåê Analyse de plateforme)
      if (module.type === 'platform_analysis' && module.payload) {
        const payload = module.payload as any;
        if (payload.findings && Array.isArray(payload.findings)) {
          allFindings.push(...payload.findings);
        }
      }
    }
    
    console.log(`‚úÖ ${allFindings.length} √©l√©ment(s) dynamique(s) trouv√©(s):`, allFindings.map(f => f.label));
    
    reportFindings.value = allFindings;
  } catch (err: any) {
    console.error('Erreur chargement √©l√©ments du rapport:', err);
    throw err;
  }
}

// Filtrer les entit√©s selon la recherche
const filteredEntities = computed(() => {
  if (!searchQuery.value.trim()) {
    return entities.value;
  }
  
  const query = searchQuery.value.toLowerCase();
  return entities.value.filter(entity => 
    entity.label.toLowerCase().includes(query) ||
    entity.type.toLowerCase().includes(query) ||
    (entity.notes && entity.notes.toLowerCase().includes(query))
  );
});

// Filtrer les findings selon la recherche
const filteredFindings = computed(() => {
  // Si on a un reportId, utiliser les Finding du rapport
  const findingsSource = props.reportId ? reportFindings.value : (props.findings || []);
  
  if (findingsSource.length === 0) {
    return [];
  }
  
  if (!searchQuery.value.trim()) {
    return findingsSource;
  }
  
  const query = searchQuery.value.toLowerCase();
  return findingsSource.filter(finding => 
    finding.label.toLowerCase().includes(query) ||
    finding.description.toLowerCase().includes(query)
  );
});

// Liste combin√©e selon le type s√©lectionn√©
const displayItems = computed(() => {
  if (dataType.value === 'entities') {
    return filteredEntities.value;
  } else {
    return filteredFindings.value;
  }
});

// G√©rer la recherche (debounce si n√©cessaire)
function handleSearch() {
  // La recherche est en temps r√©el sur les entit√©s d√©j√† charg√©es
  // Pas besoin de debounce pour l'instant
}

// S√©lectionner une entit√©
function selectEntity(entity: Entity) {
  // D√©cider automatiquement si un tableau est n√©cessaire
  const needsTable = shouldUseTable(entity);
  
  // Essayer de parser les metadata depuis notes pour r√©cup√©rer les attachments
  let attachments: string[] = [];
  if (entity.notes) {
    try {
      if (entity.notes.trim().startsWith('{')) {
        const metadata = JSON.parse(entity.notes);
        console.log('üìù Metadata parsed:', metadata);
        if (metadata.attachments && Array.isArray(metadata.attachments)) {
          attachments = metadata.attachments;
          console.log('üìé Attachments trouv√©s:', attachments);
        } else {
          console.log('‚ö†Ô∏è Pas d\'attachments dans metadata');
        }
      }
    } catch (e) {
      console.log('‚ö†Ô∏è Notes n\'est pas du JSON:', entity.notes);
    }
  } else {
    console.log('‚ö†Ô∏è Pas de notes sur cette entit√©');
  }
  
  console.log(`üéØ selectEntity: ${entity.label}, needsTable=${needsTable}, attachments=${attachments.length}`);
  
  if (needsTable) {
    // Ins√©rer un tableau structur√© HTML avec attachments si disponibles
    emit('select', entity, generateEntityTable(entity, attachments.length > 0 ? attachments : undefined));
  } else {
    // Ins√©rer du texte simple
    emit('select', entity, generateSimpleText(entity));
  }
  handleClose();
}

// S√©lectionner un finding
function selectFinding(finding: Finding) {
  console.log('üîç selectFinding:', finding.label);
  console.log('üìé Attachments dans finding:', finding.attachments);
  
  // Les findings n√©cessitent toujours un tableau structur√©
  emit('select', finding as any, generateFindingTable(finding));
  handleClose();
}

// D√©terminer si un tableau est n√©cessaire
function shouldUseTable(entity: Entity): boolean {
  // Un tableau est n√©cessaire si :
  // 1. L'entit√© a des notes longues (>100 caract√®res)
  // 2. C'est une organisation (plusieurs infos)
  // 3. L'ID est important pour r√©f√©rence
  
  const hasLongNotes = entity.notes && entity.notes.length > 100;
  const isOrganization = entity.type === 'ORGANIZATION';
  
  return hasLongNotes || isOrganization;
}

// G√©n√©rer du texte simple pour une entit√©
function generateSimpleText(entity: Entity): string {
  const type = getEntityTypeLabel(entity.type);
  
  if (entity.notes && entity.notes.trim()) {
    return `**${entity.label}** (${type}) : ${entity.notes}`;
  }
  
  return `**${entity.label}** (${type})`;
}

// G√©n√©rer un tableau HTML structur√© pour une entit√©
function generateEntityTable(entity: Entity, attachments?: string[]): string {
  const rows: string[] = [];
  
  // En-t√™te avec fond color√©
  rows.push(`<tr><th colspan="2" style="font-weight: 700; padding: 12px; border: 1px solid #cbd5e1; background-color: #8b5cf6; color: white; text-align: center; font-size: 1.1rem;">${getEntityIcon(entity.type)} ${entity.label}</th></tr>`);
  
  rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc; width: 35%;">üè∑Ô∏è Type</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${getEntityTypeLabel(entity.type)}</td></tr>`);
  rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üë§ Nom / Identifiant</td><td style="padding: 10px; border: 1px solid #cbd5e1; font-weight: 600; color: #1e40af;">${entity.label}</td></tr>`);
  
  // Essayer de parser les m√©tadonn√©es du champ notes (format JSON)
  let metadata: any = null;
  if (entity.notes) {
    try {
      // V√©rifier si notes contient du JSON
      if (entity.notes.trim().startsWith('{')) {
        metadata = JSON.parse(entity.notes);
      }
    } catch (e) {
      // Pas du JSON, afficher comme texte normal
    }
  }
  
  // Afficher les m√©tadonn√©es si disponibles
  if (metadata) {
    // Aliases
    if (metadata.aliases && Array.isArray(metadata.aliases) && metadata.aliases.length > 0) {
      const aliasesHtml = metadata.aliases.map((a: string) => `<span style="display: inline-block; padding: 4px 10px; margin: 2px; border-radius: 8px; background-color: #e0e7ff; color: #4338ca; font-size: 0.875rem;">${a}</span>`).join(' ');
      rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üé≠ Alias</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${aliasesHtml}</td></tr>`);
    }
    
    // Date de naissance
    if (metadata.dateOfBirth || metadata.personDetails?.dateOfBirth) {
      const dob = metadata.dateOfBirth || metadata.personDetails.dateOfBirth;
      const date = new Date(dob);
      const formatted = date.toLocaleDateString('fr-BE', { year: 'numeric', month: 'long', day: 'numeric' });
      rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üéÇ N√©(e) le</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${formatted}</td></tr>`);
    }
    
    // Num√©ro de Registre National
    if (metadata.nationalRegistryNumber || metadata.personDetails?.nationalRegistryNumber) {
      const rrn = metadata.nationalRegistryNumber || metadata.personDetails.nationalRegistryNumber;
      rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üÜî RRN</td><td style="padding: 10px; border: 1px solid #cbd5e1; font-family: 'Courier New', monospace; font-weight: 600; color: #dc2626;">${rrn}</td></tr>`);
    }
    
    // Adresse
    if (metadata.physicalAddress || metadata.personDetails?.physicalAddress) {
      const address = metadata.physicalAddress || metadata.personDetails.physicalAddress;
      rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üìç Adresse</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${address}</td></tr>`);
    }
    
    // T√©l√©phones
    if (metadata.phoneNumbers || metadata.personDetails?.phoneNumbers) {
      const phones = metadata.phoneNumbers || metadata.personDetails.phoneNumbers;
      if (Array.isArray(phones) && phones.length > 0) {
        const phonesHtml = phones.map((phone: string) => `<div style="margin-bottom: 4px;">üìû <a href="tel:${phone}" style="color: #3b82f6; text-decoration: underline;">${phone}</a></div>`).join('');
        rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üìû T√©l√©phone(s)</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${phonesHtml}</td></tr>`);
      }
    }
    
    // BCE (entreprise)
    if (metadata.bceNumber || metadata.companyDetails?.bceNumber) {
      const bce = metadata.bceNumber || metadata.companyDetails.bceNumber;
      rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üèõÔ∏è N¬∞ BCE</td><td style="padding: 10px; border: 1px solid #cbd5e1; font-family: 'Courier New', monospace; font-weight: 600; color: #1e40af;">${bce}</td></tr>`);
    }
    
    // Identifiants li√©s
    if (metadata.identifiers && Array.isArray(metadata.identifiers) && metadata.identifiers.length > 0) {
      const identifiersHtml = metadata.identifiers.map((id: string) => `<div style="margin-bottom: 4px;">üîó <span style="font-family: monospace;">${id}</span></div>`).join('');
      rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üîó Identifiants li√©s</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${identifiersHtml}</td></tr>`);
    }
  } else if (entity.notes && entity.notes.trim()) {
    // Afficher notes comme texte si ce n'est pas du JSON
    rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üìù Notes</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${entity.notes}</td></tr>`);
  }
  
  // Pi√®ces jointes avec miniatures (si fournies)
  if (attachments && attachments.length > 0) {
    const thumbnailsHtml = attachments.map((attachmentUrl: string) => {
      // L'URL est d√©j√† compl√®te (URL sign√©e depuis l'API)
      const imageUrl = attachmentUrl;
      return `<img src="${imageUrl}" alt="Photo ${entity.label}" style="width: 120px; height: 120px; object-fit: cover; display: block; border: 2px solid #e2e8f0; border-radius: 8px;" title="Cliquez pour agrandir" onclick="window.open('${imageUrl}', '_blank')" />`;
    }).join('');
    rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc; vertical-align: top;">üì∑ Photo${attachments.length > 1 ? 's' : ''} / Logo (${attachments.length})</td><td style="padding: 0; border: 1px solid #cbd5e1;">${thumbnailsHtml}</td></tr>`);
  }
  
  rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üîë ID syst√®me</td><td style="padding: 10px; border: 1px solid #cbd5e1; font-family: 'Courier New', monospace; font-size: 0.875rem; color: #64748b;">${entity.id}</td></tr>`);
  
  return `<table style="border-collapse: collapse; border: 2px solid #8b5cf6; width: 100%; margin: 0 0 1.5rem 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
    <tbody>${rows.join('')}</tbody>
  </table>`;
}

// G√©n√©rer un tableau HTML pour un finding (donn√©e de plateforme)
function generateFindingTable(finding: Finding): string {
  const rows: string[] = [];
  const meta = finding.metadata as any;
  
  // Ic√¥ne de plateforme
  const platformIcons: Record<string, string> = {
    facebook: 'üìò',
    instagram: 'üì∑',
    twitter: 'üê¶',
    x: 'üê¶',
    linkedin: 'üíº',
    tiktok: 'üéµ',
    snapchat: 'üëª',
    telegram: '‚úàÔ∏è',
    whatsapp: 'üí¨',
    youtube: 'üìπ',
    reddit: 'ü§ñ',
    discord: 'üéÆ',
    other: 'üåê'
  };
  const platformIcon = platformIcons[meta?.platform || 'other'] || 'üåê';
  
  // En-t√™te avec fond color√© et plateforme
  const platformName = meta?.platform ? meta.platform.charAt(0).toUpperCase() + meta.platform.slice(1) : 'Profil';
  rows.push(`<tr><th colspan="2" style="font-weight: 700; padding: 12px; border: 1px solid #cbd5e1; background-color: #3b82f6; color: white; text-align: center; font-size: 1.1rem;">${platformIcon} ${platformName} - ${finding.label}</th></tr>`);
  
  // ===== INFORMATIONS SP√âCIFIQUES √Ä LA PLATEFORME =====
  
  // URL du profil (prioritaire)
  if (meta?.profileUrl) {
    rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc; width: 35%;">üîó URL du profil</td><td style="padding: 10px; border: 1px solid #cbd5e1;"><a href="${meta.profileUrl}" target="_blank" rel="noopener noreferrer" style="color: #3b82f6; text-decoration: underline; word-break: break-all;">${meta.profileUrl}</a></td></tr>`);
  }
  
  // Username/Nom du profil
  rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üë§ Nom du profil / Username</td><td style="padding: 10px; border: 1px solid #cbd5e1; font-weight: 600; color: #1e40af;">${finding.label}</td></tr>`);
  
  // Description / Bio
  if (finding.description) {
    rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üìù Description / Bio</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${finding.description}</td></tr>`);
  }
  
  // Statut du compte avec badge
  if (meta?.accountStatus) {
    const statusLabels: Record<string, { label: string; color: string; icon: string }> = {
      active: { label: 'Actif', color: '#22c55e', icon: '‚úÖ' },
      inactive: { label: 'Inactif', color: '#6b7280', icon: '‚≠ï' },
      suspended: { label: 'Suspendu', color: '#ef4444', icon: '‚õî' },
      deleted: { label: 'Supprim√©', color: '#64748b', icon: 'üóëÔ∏è' },
      private: { label: 'Priv√©', color: '#f59e0b', icon: 'üîí' },
      unknown: { label: 'Inconnu', color: '#9ca3af', icon: '‚ùì' }
    };
    const status = statusLabels[meta.accountStatus] || statusLabels.unknown;
    rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">ÔøΩ Statut du compte</td><td style="padding: 10px; border: 1px solid #cbd5e1;"><span style="display: inline-block; padding: 4px 12px; border-radius: 12px; background-color: ${status.color}; color: white; font-size: 0.875rem; font-weight: 600;">${status.icon} ${status.label}</span></td></tr>`);
  }
  
  // Derni√®re activit√©
  if (meta?.lastActive) {
    const date = new Date(meta.lastActive);
    const formatted = date.toLocaleString('fr-BE', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
    rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üìÖ Derni√®re activit√©</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${formatted}</td></tr>`);
  }
  
  // Nombre d'abonn√©s
  if (meta?.followers !== undefined && meta?.followers !== null) {
    rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">ÔøΩ Nombre d'abonn√©s</td><td style="padding: 10px; border: 1px solid #cbd5e1; font-weight: 600; color: #3b82f6;">${meta.followers.toLocaleString('fr-BE')}</td></tr>`);
  }
  
  // Capture d'√©cran (si disponible)
  if (meta?.screenshot) {
    rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üì∏ Capture d'√©cran</td><td style="padding: 10px; border: 1px solid #cbd5e1;"><span style="color: #22c55e;">‚úì Disponible</span></td></tr>`);
  }
  
  // ===== M√âTADONN√âES G√âN√âRALES =====
  
  // Niveau de confiance
  if (finding.confidence) {
    const confidenceColors: Record<ConfidenceLevel, string> = {
      confirmed: '#22c55e',
      probable: '#3b82f6',
      possible: '#f59e0b',
      unknown: '#6b7280'
    };
    const color = confidenceColors[finding.confidence] || '#6b7280';
    rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">‚≠ê Niveau de confiance</td><td style="padding: 10px; border: 1px solid #cbd5e1;"><span style="display: inline-block; padding: 4px 12px; border-radius: 12px; background-color: ${color}; color: white; font-size: 0.875rem; font-weight: 600;">${getConfidenceLabel(finding.confidence)}</span></td></tr>`);
  }
  
  // Sources avec liens cliquables
  if (finding.sources && finding.sources.length > 0) {
    const sourcesHtml = finding.sources.map((s, idx) => {
      const icon = s.type === 'url' ? 'üîó' : s.type === 'document' ? 'üìÑ' : s.type === 'database' ? 'üíæ' : 'üí¨';
      if (s.type === 'url') {
        return `<div style="margin-bottom: 8px;">${icon} <a href="${s.value}" target="_blank" rel="noopener noreferrer" style="color: #3b82f6; text-decoration: underline;">${s.value}</a>${s.note ? ` <em style="color: #64748b; font-size: 0.875rem;">(${s.note})</em>` : ''}</div>`;
      }
      return `<div style="margin-bottom: 8px;">${icon} ${s.value}${s.note ? ` <em style="color: #64748b; font-size: 0.875rem;">(${s.note})</em>` : ''}</div>`;
    }).join('');
    rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üìö Sources</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${sourcesHtml}</td></tr>`);
  }
  
  // ===== M√âTADONN√âES ENRICHIES (PersonDetails, CompanyDetails, etc.) =====
  
  // Type d'entit√©
  if (meta?.entityType) {
    const typeLabels: Record<string, string> = {
      person: 'üë§ Personne',
      organization: 'üè¢ Organisation',
      company: 'üè≠ Soci√©t√©',
      group: 'üë• Groupe',
      alias: 'üé≠ Alias',
      other: 'üìå Autre'
    };
    rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üè∑Ô∏è Type d'entit√©</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${typeLabels[meta.entityType] || meta.entityType}</td></tr>`);
  }
  
  // Statut de v√©rification
  if (meta?.isVerified !== undefined) {
    const verifiedBadge = meta.isVerified 
      ? '<span style="display: inline-block; padding: 4px 12px; border-radius: 12px; background-color: #22c55e; color: white; font-size: 0.875rem; font-weight: 600;">‚úì V√©rifi√©</span>'
      : '<span style="display: inline-block; padding: 4px 12px; border-radius: 12px; background-color: #ef4444; color: white; font-size: 0.875rem; font-weight: 600;">‚úó Non v√©rifi√©</span>';
    rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üîê Statut de v√©rification</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${verifiedBadge}</td></tr>`);
  }
  
  // Aliases
  if (meta?.aliases && meta.aliases.length > 0) {
    const aliasesHtml = meta.aliases.map((a: string) => `<span style="display: inline-block; padding: 4px 10px; margin: 2px; border-radius: 8px; background-color: #e0e7ff; color: #4338ca; font-size: 0.875rem;">${a}</span>`).join(' ');
    rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üé≠ Aliases / Pseudonymes</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${aliasesHtml}</td></tr>`);
  }
  
  // D√©tails de personne
  if (meta?.personDetails) {
    const pd = meta.personDetails;
      rows.push(`<tr><td colspan="2" style="font-weight: 700; padding: 10px; border: 1px solid #cbd5e1; background-color: #eff6ff; color: #1e40af;">üë§ Informations personnelles</td></tr>`);
      
      if (pd.dateOfBirth) {
        const date = new Date(pd.dateOfBirth);
        const formatted = date.toLocaleDateString('fr-BE', { year: 'numeric', month: 'long', day: 'numeric' });
        rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc; padding-left: 30px;">üìÖ Date de naissance</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${formatted}</td></tr>`);
      }
      
      if (pd.nationalRegistryNumber) {
        rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc; padding-left: 30px;">üÜî Num√©ro de Registre National</td><td style="padding: 10px; border: 1px solid #cbd5e1; font-family: 'Courier New', monospace; font-weight: 600; color: #dc2626;">${pd.nationalRegistryNumber}</td></tr>`);
      }
      
      if (pd.physicalAddress) {
        rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc; padding-left: 30px;">üìç Adresse physique</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${pd.physicalAddress}</td></tr>`);
      }
      
      if (pd.phoneNumbers && pd.phoneNumbers.length > 0) {
        const phonesHtml = pd.phoneNumbers.map((phone: string) => `<div style="margin-bottom: 4px;">üìû <a href="tel:${phone}" style="color: #3b82f6; text-decoration: underline;">${phone}</a></div>`).join('');
        rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc; padding-left: 30px;">üìû T√©l√©phones</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${phonesHtml}</td></tr>`);
      }
    }
    
    // D√©tails de soci√©t√©
    if (meta.companyDetails) {
      const cd = meta.companyDetails;
      rows.push(`<tr><td colspan="2" style="font-weight: 700; padding: 10px; border: 1px solid #cbd5e1; background-color: #fef3c7; color: #92400e;">üè¢ Informations de soci√©t√©</td></tr>`);
      
      if (cd.bceNumber) {
        rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc; padding-left: 30px;">üèõÔ∏è N¬∞ BCE</td><td style="padding: 10px; border: 1px solid #cbd5e1; font-family: 'Courier New', monospace; font-weight: 600; color: #1e40af;">${cd.bceNumber}</td></tr>`);
      }
      
      if (cd.headquartersAddress) {
        rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc; padding-left: 30px;">üè¢ Si√®ge social</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${cd.headquartersAddress}</td></tr>`);
      }
      
      if (cd.operationalAddresses && cd.operationalAddresses.length > 0) {
        const addressesHtml = cd.operationalAddresses.map((addr: string) => `<div style="margin-bottom: 4px;">üìç ${addr}</div>`).join('');
        rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc; padding-left: 30px;">üè≠ Adresses d'exploitation</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${addressesHtml}</td></tr>`);
      }
      
      if (cd.website) {
        rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc; padding-left: 30px;">üåê Site web</td><td style="padding: 10px; border: 1px solid #cbd5e1;"><a href="${cd.website}" target="_blank" rel="noopener noreferrer" style="color: #3b82f6; text-decoration: underline;">${cd.website}</a></td></tr>`);
      }
      
      if (cd.phoneNumbers && cd.phoneNumbers.length > 0) {
        const phonesHtml = cd.phoneNumbers.map((phone: string) => `<div style="margin-bottom: 4px;">üìû <a href="tel:${phone}" style="color: #3b82f6; text-decoration: underline;">${phone}</a></div>`).join('');
        rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc; padding-left: 30px;">üìû T√©l√©phones</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${phonesHtml}</td></tr>`);
      }
    }
    
    // Identifiants li√©s
    if (meta.relatedIdentifiers && meta.relatedIdentifiers.length > 0) {
      rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üîó Identifiants li√©s</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${meta.relatedIdentifiers.length} identifiant(s)</td></tr>`);
    }
    
    // Plateformes li√©es
    if (meta.relatedPlatforms && meta.relatedPlatforms.length > 0) {
      rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üì± Plateformes li√©es</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${meta.relatedPlatforms.length} plateforme(s)</td></tr>`);
    }
  
  // Pi√®ces jointes avec miniatures
  if (finding.attachments && finding.attachments.length > 0) {
    console.log('üñºÔ∏è generateFindingTable: G√©n√©ration des miniatures');
    console.log('üìé finding.attachments:', finding.attachments);
    console.log('üìä Nombre d\'attachments:', finding.attachments.length);
    
    // Convertir le Proxy en tableau normal
    const attachmentsArray = Array.from(finding.attachments);
    console.log('üìã attachmentsArray:', attachmentsArray);
    
    const thumbnailsHtml = attachmentsArray.map((attachmentUrl: string, index: number) => {
      console.log(`  üîó [${index}] URL:`, attachmentUrl);
      
      // L'URL est d√©j√† compl√®te (URL sign√©e depuis l'API)
      const imageUrl = attachmentUrl;
      return `<img src="${imageUrl}" alt="Pi√®ce jointe" style="width: 120px; height: 120px; object-fit: cover; display: block; border: 2px solid #e2e8f0; border-radius: 8px;" title="Cliquez pour agrandir" onclick="window.open('${imageUrl}', '_blank')" />`;
    }).join('');
    
    console.log('üé® HTML g√©n√©r√©:', thumbnailsHtml);
    
    rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc; vertical-align: top;">üìé Pi√®ces jointes (${finding.attachments.length})</td><td style="padding: 0; border: 1px solid #cbd5e1;">${thumbnailsHtml}</td></tr>`);
  }
  
  // Entit√©s li√©es
  if (finding.relatedEntities && finding.relatedEntities.length > 0) {
    rows.push(`<tr><td style="font-weight: 600; padding: 10px; border: 1px solid #cbd5e1; background-color: #f8fafc;">üë• Entit√©s li√©es</td><td style="padding: 10px; border: 1px solid #cbd5e1;">${finding.relatedEntities.length} entit√©(s)</td></tr>`);
  }
  
  const tableHtml = `<table style="border-collapse: collapse; border: 2px solid #3b82f6; width: 100%; margin: 0 0 1.5rem 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
    <tbody>${rows.join('')}</tbody>
  </table>`;
  
  console.log('üìã Tableau HTML complet g√©n√©r√© pour:', finding.label);
  console.log('üìè Nombre de lignes (rows):', rows.length);
  
  return tableHtml;
}

// Labels pour les niveaux de confiance
function getConfidenceLabel(level: ConfidenceLevel): string {
  const labels: Record<ConfidenceLevel, string> = {
    confirmed: 'Confirm√©',
    probable: 'Probable',
    possible: 'Possible',
    unknown: 'Inconnu'
  };
  return labels[level] || level;
}

// Classes CSS pour les badges de confiance
function getConfidenceBadgeClass(level: ConfidenceLevel): string {
  const classes: Record<ConfidenceLevel, string> = {
    confirmed: 'badge-success',
    probable: 'badge-info',
    possible: 'badge-warning',
    unknown: 'badge-neutral'
  };
  return classes[level] || 'badge-neutral';
}

// Fermer le modal
function handleClose() {
  searchQuery.value = '';
  emit('close');
}

// Obtenir l'ic√¥ne d'une entit√©
function getEntityIcon(type: EntityType): string {
  return entityIcons[type] || 'üè∑Ô∏è';
}

// Obtenir le label d'un type d'entit√©
function getEntityTypeLabel(type: EntityType): string {
  return entityTypeLabels[type] || 'Autre';
}

// Charger les entit√©s quand le modal s'ouvre
watch(() => props.isOpen, async (isOpen) => {
  if (isOpen) {
    await loadEntities();
    // Focus sur le champ de recherche
    nextTick(() => {
      searchInputRef.value?.focus();
    });
  }
});
</script>

<style scoped>
/* Styles additionnels si n√©cessaire */
</style>
